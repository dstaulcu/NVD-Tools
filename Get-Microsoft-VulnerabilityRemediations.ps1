<#
https://github.com/microsoft/MSRC-Microsoft-Security-Updates-API
https://portal.msrc.microsoft.com/en-us/security-guidance
https://portal.msrc.microsoft.com/en-us/developer  

#>

### Install the module from the PowerShell Gallery
Install-Module -Name MsrcSecurityUpdates -Scope CurrentUser

### Load the module
Import-Module -Name MsrcSecurityUpdates

### GET/SET THE API KEY
$apikeyfile = "$($env:userprofile)\documents\msrc_apikey.txt"
if (!(Test-Path -Path $apikeyfile)) { 
    write-host "api key file not foundin $($apikeyfile)"
    break 
} 
$apikey = Get-Content -Path $apikeyfile 
Set-MSRCApiKey -ApiKey $apikey

### INITIALIZE OUTPUT FILE
$outputfile = "$($env:TEMP)\Microsoft-Security-Updates.csv"
if (Test-Path -Path $outputfile) { Remove-Item -Path $outputfile -Force } 

### INITIALIZE REPORT DATE FILTER
$currentdate = get-date
$currentYear = $currentdate.Year
$currentMonth = $currentdate.Month

### GET ALL POSSIBLE REPORT NAMES
$Reports = @()
for ($year = 2016; $year -le $currentYear; $year++)
{ 
    for ($month = 1; $month -le 12; $month++)
    {
        if (!(($year -eq "2016" -and $month -lt 4) -or ($year -eq $currentYear -and $month -gt $currentMonth)))
        {
            $ReportCounter++
            $monthname = (Get-Culture).DateTimeFormat.GetMonthName($month).Substring(0,3)
            $Name = "$($year)-$($monthname)"

            $info = @{
                Number = $ReportCounter
                Name = $Name
            }
            $Reports += New-Object -TypeName PSObject -Property $Info
        }

    }    
}

### PROMPT USER FOR REPORTS OF INTEREST
<#
[array]$SelectedReports = $Reports | sort-object -Property Number -Descending | Select-object -Property Number, Name | Out-GridView -Title "Select one or more Microsoft CVRF reports" -PassThru
if (!($SelectedReports)) { Break } 
#>
$SelectedReports = $Reports

### PROMPT USER FOR PRODUCTS OF INTEREST BASED ON CURRENT MONTH PRODUCTS
<#
$cvrfDoc = Get-MsrcCvrfDocument -ID $Reports[-1].Name
[array]$SelectedProducts = $CVRFDoc.ProductTree.FullProductName | Sort-object Value | Out-GridView -PassThru -Title "Select one or more products to include"
if (!($SelectedProducts)) { Break } 

# BUILD A REGEXP MATCH STRING FOR THE SELECTED PRODUCTS
$ProductsOfInterest = ".*"
foreach ($product in $SelectedProducts) {
    if ($ProductsOfInterest -eq "") {         
        $ProductsOfInterest = $product.ProductID
    } else {
        $ProductsOfInterest += "|$($product.ProductID)"

    }
}
$ProductsOfInterest = "($($ProductsOfInterest))"
#>
$ProductsOfInterest = "(.*)"

### RUN REPORT FOR EACH MONTH
$ReportCounter = 0
foreach ($Report in $SelectedReports) {
    $ReportCounter++
    $pct_complete = ($ReportCounter / $SelectedReports.Count*100)
    Write-Progress -Activity "Processing $($Report.Name) CVRF document from Microsoft" -Status "Step $($ReportCounter) of $($SelectedReports.count)" -PercentComplete $pct_complete;


    ### GET MICROSFT COMMON VULNERABILITY RESPONSE FRAMEWORK DOCUMENT FOR PERIOD OF INTEREST
    $cvrfDoc = Get-MsrcCvrfDocument -ID $Report.name

    ### BUILD RECORDSET OF PRODUCT PATCH INFO FOR REMEDIATIONS TO CVE VULNERABILITES
    $Records = @()
    foreach ($Vulnerability in $cvrfDoc.Vulnerability) {

        ### LOOP THROUGH REMEDIATIONS
        foreach ($Remediation in $Vulnerability.Remediations | WHERE SubType -eq "Security Update") {

            ### LOOP THROUGH PRODUCTS
            foreach ($ProductID in $Remediation.ProductID) {
        
                ### PROCESS ONLY PRODUCTS OF INTEREST
                if ($ProductID -match  "^$($ProductsOfInterest)$") {
   
                    ### PREPARE OF HASHTABLE HAVING VALUES OF INTEREST
                    $info = @{
                        CVE = $Vulnerability.CVE
                        CvrfDocument = $Report.Name
                        LastRevisionDate = ($vulnerability.RevisionHistory | Sort-Object -Property Number -Descending  | Select-Object -First 1).Date
                        FullProductName = ($CVRFDoc.ProductTree.FullProductName | Where ProductID -eq ($ProductID)).Value
                        Article = ($Remediation.Description).Value
                        Severity = ((($Vulnerability.Threats | ?{(($_.ProductID -eq $ProductID) -AND ($_.'Type' -eq 3))})).Description).Value
                        Impact = ((($Vulnerability.Threats | ?{(($_.ProductID -eq $ProductID) -AND ($_.'Type' -eq 0))})).Description).Value
                        Title = ($Vulnerability.Title).Value
                        Supercedence = $Remediation.Supercedence
                        DownloadURL = $Remediation.URL
                        #Notes = ($Vulnerability.Notes | Where Title -EQ "Description").Value -replace '<[^>]+>',''
                    }

                    ### APPEND HASHTABLE (RECORD) TO PSCUSTOMBJECT (RECORDSET)
                    $Records += New-Object -TypeName PSObject -Property $Info
                }
            }
        }       
    } 

    $Records = $Records | Where-Object {$_.CVE -match "^CVE"}
    $Records | Sort-Object -Property CVE, FullProductName -Descending | Select CVE, CvrfDocument, LastRevisionDate, FullProductName, Article, Severity, Impact, Title, Supercedence, DownloadURL | Export-Csv -Path $outputfile -NoTypeInformation -Append
}

Import-Csv -Path $outputfile | Out-GridView -Title "Security updates in $($outputfile)."
